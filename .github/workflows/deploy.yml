
name: Deploy Bedrock + Sage

on:
  push:
    branches:
      - master
      - develop
  workflow_dispatch:
    inputs:
      app_env:
        description: "Override APP_ENV (live|dev). Leave empty to auto-detect from branch."
        required: false
        default: ""

env:
  APP_NAME: ${{ vars.APP_NAME }}
  THEME_NAME: ${{ vars.THEME_NAME }}

jobs:
  sanity-and-derive:
    name: Derive & Validate Environment
    runs-on: ubuntu-latest
    outputs:
      app_env: ${{ steps.outvars.outputs.app_env }}
      deploy_path: ${{ steps.outvars.outputs.deploy_path }}
      theme_local_path: ${{ steps.outvars.outputs.theme_local_path }}
      theme_remote_path: ${{ steps.outvars.outputs.theme_remote_path }}
    steps:
      - name: Compute APP_ENV from branch
        id: outvars
        run: |
          BRANCH="${GITHUB_REF##*/}"
          OVERRIDE="${{ github.event.inputs.app_env || vars.APP_ENV }}"

          if [ -n "$OVERRIDE" ]; then
            APP_ENV="$OVERRIDE"
          else
            case "$BRANCH" in
              master) APP_ENV="live" ;;
              develop) APP_ENV="dev" ;;
              *) echo "Unsupported branch $BRANCH" >&2; exit 1 ;;
            esac
          fi

          if [ -z "${{ env.APP_NAME }}" ] || [ -z "${{ env.THEME_NAME }}" ]; then
            echo "APP_NAME and THEME_NAME are required repo variables." >&2
            exit 1
          fi

          DEPLOY_PATH="/srv/users/serverpilot/apps/${APP_ENV}${{ env.APP_NAME }}"

          THEME_LOCAL_PATH="web/app/themes/${{ env.THEME_NAME }}"
          THEME_REMOTE_PATH="${DEPLOY_PATH}/web/app/themes/${{ env.THEME_NAME }}"

          case "$THEME_LOCAL_PATH" in
            web/app/themes/*) ;; # ok
            *) echo "::error ::THEME_LOCAL_PATH must be within web/app/themes/. Got $THEME_LOCAL_PATH" ; exit 1 ;;
          esac

          echo "deploy_path=$DEPLOY_PATH" >> "$GITHUB_OUTPUT"
          echo "theme_local_path=$THEME_LOCAL_PATH" >> "$GITHUB_OUTPUT"
          echo "theme_remote_path=$THEME_REMOTE_PATH" >> "$GITHUB_OUTPUT"
          echo "app_env=$APP_ENV" >> "$GITHUB_OUTPUT"

  build-bedrock:
    name: Build Bedrock (Composer)
    needs: sanity-and-derive
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP 8.4 + Composer v2
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          tools: composer:v2
          coverage: none

      - name: Cache Composer (project)
        uses: actions/cache@v4
        with:
          path: |
            ~/.composer/cache
            vendor
          key: composer-${{ hashFiles('**/composer.lock') }}

      # IMPORTANT FIX â€” Dotenv MUST be included for Bedrock
      - name: Install Bedrock Dependencies
        run: |
          composer install --no-interaction --prefer-dist

      - name: Upload Bedrock Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bedrock-build
          path: |
            vendor/**
            .env
          if-no-files-found: ignore

  build-sage:
    name: Build Sage Assets (Node 20.20.0)
    needs: [sanity-and-derive, build-bedrock]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download Bedrock Artifacts
        uses: actions/download-artifact@v4
        with:
          name: bedrock-build

      - name: Setup PHP 8.4 + Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          tools: composer:v2
          coverage: none

      - name: Setup Node 20.20.0
        uses: actions/setup-node@v4
        with:
          node-version: "20.20.0"
          cache: yarn
          cache-dependency-path: ${{ needs.sanity-and-derive.outputs.theme_local_path }}/yarn.lock

      - name: Use Yarn 4.12.0 via Corepack
        run: |
          corepack enable
          corepack prepare yarn@4.12.0 --activate
          yarn --version

      - name: Cache Composer (theme vendor)
        uses: actions/cache@v4
        with:
          path: |
            ~/.composer/cache
            ${{ needs.sanity-and-derive.outputs.theme_local_path }}/vendor
          key: composer-theme-${{ hashFiles(format('{0}/composer.lock', needs.sanity-and-derive.outputs.theme_local_path)) }}

      - name: Install Theme Dependencies + Build
        working-directory: ${{ needs.sanity-and-derive.outputs.theme_local_path }}
        env:
          NODE_ENV: production
        run: |
          if [ -f composer.json ]; then
            composer install --no-interaction --prefer-dist
          fi
          yarn install --immutable || yarn install
          yarn build --mode=production

      - name: Verify theme build output
        working-directory: ${{ needs.sanity-and-derive.outputs.theme_local_path }}
        run: |
          if [ ! -d public ] || [ -z "$(ls -A public || true)" ]; then
            echo "::error ::Theme build missing public/ assets"
            exit 1
          fi

      - name: Upload Sage Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sage-build
          path: |
            ${{ needs.sanity-and-derive.outputs.theme_local_path }}/public/**
            ${{ needs.sanity-and-derive.outputs.theme_local_path }}/vendor/**
            ${{ needs.sanity-and-derive.outputs.theme_local_path }}/node_modules/**
            ${{ needs.sanity-and-derive.outputs.theme_local_path }}/.yarn/**
          if-no-files-found: ignore

  deploy:
    name: Deploy via SSH + rsync
    needs: [sanity-and-derive, build-sage]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download Bedrock Artifacts
        uses: actions/download-artifact@v4
        with:
          name: bedrock-build

      - name: Download Sage Artifacts
        uses: actions/download-artifact@v4
        with:
          name: sage-build
          path: .

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.SERVER_IP }}" >> ~/.ssh/known_hosts

      # Dev-only deploy path check
      - name: Check/flag dev path existence
        id: devpath
        if: needs.sanity-and-derive.outputs.app_env == 'dev'
        run: |
          if ssh serverpilot@${{ secrets.SERVER_IP }} "test -d '${{ needs.sanity-and-derive.outputs.deploy_path }}'"; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip deploy if dev path missing
        if: needs.sanity-and-derive.outputs.app_env == 'dev' && steps.devpath.outputs.exists != 'true'
        run: |
          echo "Dev path missing. Skipping."
          exit 0

      - name: Detect theme artifact source
        id: srcdir
        run: |
          A="${{ needs.sanity-and-derive.outputs.theme_local_path }}"
          B="."
          if [ -d "$A/public" ]; then
            echo "src=$A" >> "$GITHUB_OUTPUT"
            echo "Using full theme path."
          elif [ -d "$B/public" ]; then
            echo "src=$B" >> "$GITHUB_OUTPUT"
            echo "Using flattened artifact path."
          else
            echo "::error ::No built theme assets found."
            exit 1
          fi

      # Safety: prevent overwriting ServerPilot public/ symlink
      - name: Guard - ensure remote theme path is safe
        run: |
          REMOTE_DEPLOY="${{ needs.sanity-and-derive.outputs.deploy_path }}"
          REMOTE_THEME="${{ needs.sanity-and-derive.outputs.theme_remote_path }}"

          case "$REMOTE_THEME" in
            "$REMOTE_DEPLOY"/web/app/themes/*) ;;
            *) echo "::error ::Remote theme path invalid: $REMOTE_THEME"; exit 1 ;;
          esac

          # WAF safety check (Wordfence must NOT be touched)
          ssh serverpilot@${{ secrets.SERVER_IP }} bash -lc "
            if [ ! -f '$REMOTE_DEPLOY/web/wp/wordfence-waf.php' ]; then
              echo '::warning ::wordfence-waf.php missing BEFORE deploy.'
            fi
          "

      - name: Rsync Bedrock & Theme to Server
        if: needs.sanity-and-derive.outputs.app_env == 'live' || steps.devpath.outputs.exists == 'true'
        run: |
          set -e

          REMOTE_BASE="serverpilot@${{ secrets.SERVER_IP }}:"
          REMOTE_DEPLOY="${{ needs.sanity-and-derive.outputs.deploy_path }}"
          REMOTE_THEME="${{ needs.sanity-and-derive.outputs.theme_remote_path }}"
          SRC="${{ steps.srcdir.outputs.src }}"
          APP_ENV="${{ needs.sanity-and-derive.outputs.app_env }}"

          # Exclusions: Never overwrite Wordfence WAF or logs
          EXCLUDES="--exclude=web/wp/wordfence-waf.php --exclude=web/wp/wflogs/"

          # Vendor + env (Bedrock)
          rsync -az --delete vendor/ "${REMOTE_BASE}${REMOTE_DEPLOY}/vendor/"

          [ -f ".env" ] && rsync -az .env "${REMOTE_BASE}${REMOTE_DEPLOY}/.env" || true

          # Theme public assets
          rsync -az --delete $EXCLUDES "$SRC/public/" "${REMOTE_BASE}${REMOTE_THEME}/public/"

          # Theme vendor
          if [ -d "$SRC/vendor" ]; then
            rsync -az --delete "$SRC/vendor/" "${REMOTE_BASE}${REMOTE_THEME}/vendor/"
          fi

          # Dev-only: sync node_modules + .yarn
          if [ "$APP_ENV" = "dev" ]; then
            if [ -d "$SRC/node_modules" ]; then
              rsync -az --delete "$SRC/node_modules/" "${REMOTE_BASE}${REMOTE_THEME}/node_modules/"
            fi

            if [ -d "$SRC/.yarn" ]; then
              rsync -az --delete "$SRC/.yarn/" "${REMOTE_BASE}${REMOTE_THEME}/.yarn/"
            fi
          fi

      - name: Post-deploy tasks (Acorn optimize, perms, WAF check)
        if: needs.sanity-and-derive.outputs.app_env == 'live' || steps.devpath.outputs.exists == 'true'
        run: |
          ssh serverpilot@${{ secrets.SERVER_IP }} bash -lc "
            set -e
            cd '${{ needs.sanity-and-derive.outputs.deploy_path }}'

            # Ensure Wordfence WAF still exists
            if [ ! -f 'web/wp/wordfence-waf.php' ]; then
              echo '::error ::Wordfence WAF missing after deploy.'
              exit 1
            fi

            wp acorn optimize || true

            chown -R serverpilot:serverpilot .
            find . -type d -exec chmod 0775 {} \;
            find . -type f -exec chmod 0664 {} \;

            echo 'Deployment complete.'
          "
