
name: Deploy Bedrock + Sage

on:
  push:
    branches:
      - master
      - develop

  workflow_dispatch:
    inputs:
      app_env:
        description: "Override APP_ENV (live|dev). Leave empty to auto-detect from branch."
        required: false
        default: ""

env:
  APP_NAME: ${{ vars.APP_NAME }}
  THEME_NAME: ${{ vars.THEME_NAME }}

############################################################
# 1. DERIVE ENVIRONMENT & PATHS
############################################################
jobs:
  sanity-and-derive:
    runs-on: ubuntu-latest
    outputs:
      app_env: ${{ steps.vars.outputs.app_env }}
      deploy_path: ${{ steps.vars.outputs.deploy_path }}
      theme_local_path: ${{ steps.vars.outputs.theme_local_path }}
      theme_remote_path: ${{ steps.vars.outputs.theme_remote_path }}

    steps:
      - id: vars
        run: |
          BRANCH="${GITHUB_REF##*/}"
          OVERRIDE="${{ github.event.inputs.app_env || vars.APP_ENV }}"

          if [ -n "$OVERRIDE" ]; then
            APP_ENV="$OVERRIDE"
          else
            case "$BRANCH" in
              master) APP_ENV="live" ;;
              develop) APP_ENV="dev" ;;
              *) echo "::error ::Unsupported branch $BRANCH"; exit 1 ;;
            esac
          fi

          if [ -z "${{ env.APP_NAME }}" ] || [ -z "${{ env.THEME_NAME }}" ]; then
            echo "::error ::APP_NAME and THEME_NAME repo vars missing"
            exit 1
          fi

          DEPLOY_PATH="/srv/users/serverpilot/apps/${APP_ENV}${{ env.APP_NAME }}"
          THEME_LOCAL_PATH="web/app/themes/${{ env.THEME_NAME }}"
          THEME_REMOTE_PATH="$DEPLOY_PATH/web/app/themes/${{ env.THEME_NAME }}"

          echo "app_env=$APP_ENV" >> $GITHUB_OUTPUT
          echo "deploy_path=$DEPLOY_PATH" >> $GITHUB_OUTPUT
          echo "theme_local_path=$THEME_LOCAL_PATH" >> $GITHUB_OUTPUT
          echo "theme_remote_path=$THEME_REMOTE_PATH" >> $GITHUB_OUTPUT

############################################################
# 2. BUILD BEDROCK (COMPOSER)
############################################################
  build-bedrock:
    needs: sanity-and-derive
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          tools: composer:v2

      - uses: actions/cache@v4
        with:
          path: |
            ~/.composer/cache
            vendor
          key: composer-${{ hashFiles('composer.lock') }}

      - name: Composer Install (Bedrock)
        run: composer install --prefer-dist --no-interaction

      - uses: actions/upload-artifact@v4
        with:
          name: bedrock
          path: |
            vendor/**
            composer.json
            composer.lock
            .env
          if-no-files-found: ignore

############################################################
# 3. BUILD SAGE (NODE + COMPOSER)
############################################################
  build-sage:
    needs: [sanity-and-derive, build-bedrock]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: bedrock

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          tools: composer:v2

      - uses: actions/setup-node@v4
        with:
          node-version: "20.20.0"
          cache: yarn
          cache-dependency-path: ${{ needs.sanity-and-derive.outputs.theme_local_path }}/yarn.lock

      - name: Yarn 4.x
        run: |
          corepack enable
          corepack prepare yarn@4.12.0 --activate

      - uses: actions/cache@v4
        with:
          path: |
            ~/.composer/cache
            ${{ needs.sanity-and-derive.outputs.theme_local_path }}/vendor
          key: theme-composer-${{ hashFiles(format('{0}/composer.lock', needs.sanity-and-derive.outputs.theme_local_path)) }}

      - name: Build Sage Theme
        working-directory: ${{ needs.sanity-and-derive.outputs.theme_local_path }}
        env:
          NODE_ENV: production
        run: |
          composer install --prefer-dist --no-interaction || true
          yarn install --immutable || yarn install
          yarn build --mode=production

      - uses: actions/upload-artifact@v4
        with:
          name: sage
          path: |
            ${{ needs.sanity-and-derive.outputs.theme_local_path }}/public/**
            ${{ needs.sanity-and-derive.outputs.theme_local_path }}/vendor/**
            ${{ needs.sanity-and-derive.outputs.theme_local_path }}/node_modules/**
            ${{ needs.sanity-and-derive.outputs.theme_local_path }}/.yarn/**
          if-no-files-found: ignore

############################################################
# 4. DEPLOY VIA SSH + RSYNC
############################################################
  deploy:
    needs: [sanity-and-derive, build-sage]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: bedrock

      - uses: actions/download-artifact@v4
        with:
          name: sage
          path: .

      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - run: ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      ######################################################
      # DEPLOY RSYNC
      ######################################################
      - name: Rsync Deployed Assets
        run: |
          REMOTE="serverpilot@${{ secrets.SERVER_IP }}"
          BASE="${{ needs.sanity-and-derive.outputs.deploy_path }}"
          THEME="${{ needs.sanity-and-derive.outputs.theme_remote_path }}"
          SRC_THEME="${{ needs.sanity-and-derive.outputs.theme_local_path }}"
          APP_ENV="${{ needs.sanity-and-derive.outputs.app_env }}"

          echo "=== Sync composer.json & composer.lock ==="
          rsync -az composer.json composer.lock "$REMOTE:$BASE/"

          echo "=== Sync vendor/ ==="
          rsync -az --delete vendor/ "$REMOTE:$BASE/vendor/"

          echo "=== Sync .env ==="
          [ -f ".env" ] && rsync -az .env "$REMOTE:$BASE/.env"

          echo "=== Sync theme public/ ==="
          rsync -az --delete "$SRC_THEME/public/" "$REMOTE:$THEME/public/"

          echo "=== Sync theme vendor ==="
          if [ -d "$SRC_THEME/vendor" ]; then
            rsync -az --delete "$SRC_THEME/vendor/" "$REMOTE:$THEME/vendor/"
          fi

          if [ "$APP_ENV" = "dev" ]; then
            [ -d "$SRC_THEME/node_modules" ] && rsync -az --delete "$SRC_THEME/node_modules/" "$REMOTE:$THEME/node_modules/"
            [ -d "$SRC_THEME/.yarn" ] && rsync -az --delete "$SRC_THEME/.yarn/" "$REMOTE:$THEME/.yarn/"
          fi

      ######################################################
      # POSTâ€‘DEPLOY (ACORN OPTIMIZE, WAF CHECK, PERMS)
      ######################################################
      - name: Finalize
        run: |
          ssh serverpilot@${{ secrets.SERVER_IP }} bash -lc "
            cd '${{ needs.sanity-and-derive.outputs.deploy_path }}'

            if [ ! -f web/wp/wordfence-waf.php ]; then
              echo '::error ::Wordfence WAF missing!'
              exit 1
            fi

            wp acorn optimize || true

            chown -R serverpilot:serverpilot .
            find . -type d -exec chmod 775 {} \;
            find . -type f -exec chmod 664 {} \;

            echo 'Deploy complete.'
          "
